# 网络学习

## 1.OSI七层网络结构

| 七层网络结构 |                                          |      |
| ------ | ---------------------------------------- | ---- |
| 应用层    | 为用户提供服务，常见http,https,ftp,pop3,smtp       |      |
| 表示层    | 用于表示层数据编码转换功能，确保能被另一个系统的应用层识别            |      |
| 会话层    | 负责建立、管理、终止表示层实体之间的通话。该层的通信由不同设备中的应用程序的服务请求响应组成。 |      |
| 传输层    | 建立主机端到端的链接，为上层协议提供可靠的端到端的可靠透明的数据传输服务，(可将过大的数据包分割)。TCP/UDP |      |
| 网络层    | 通过IP寻址建立两个节点间链接，为源端的传输层，选择路由和交换节点。IP层(路由器) |      |
| 数据链路层  | 格式化数据，定义了如何传输及控制对物理介质的访问，提供错误监测及纠正，确保可靠性。（交换机）将比特组成字节，由字节转换为帧，使用链路层地址(以太网MAC地址)。数据链路层分为两个子层：逻辑链路控制子层(LLC),媒体访问控制子层(MAC) |      |
| 物理层    | 传输比特流，电流强弱0/1传输(模数转换)，定义了传输介质的类型。介质:解调器、网线、双绞线。 |      |

发送方：从上至下处理头部

接收方:从下至上处理头部

## 2.TCP/IP  5层网络结构

![img](https://images2015.cnblogs.com/blog/705728/201604/705728-20160424234825491-384470376.png)

## 3.TCP三次握手

### 3.1TCP协议

面对链接、可靠、基于字节流的传输层通讯协议。将应用层的数据流分割成报文段，发送给接收方tcp层(数据包大小依据目标计算机最大传输单元mpu决定)

TCP将数据包给IP层，数据包上有序号保证顺序(防止不丢包)。对方收到，则发送ack确认，否则重传。tcp用一个奇偶和函数校验传输过程中数据包是否有误

### 3.2TCP报文结构



![img](https://images2015.cnblogs.com/blog/964016/201608/964016-20160829215953168-1927861560.png)



4个字节序号：标识报文的顺序； 如果一个报文序号107，报文大小100，则下一个报文序号是207

4个字节确认方ACK：代表着目标服务器期望收到的下一个报文序号(如果B接受到A的报文序号是301，报文长度是200，那么B在接受搭配报文序号就是500=301+200-1；那么A再接收到B的确认号以后，会将序列号置为501)

URG:紧急指针，1有效 0可忽略

**ACK**:确认序号标识  1有效 0:报文不含ack信息

PSH:push标志  1push标识，目标服务器接受到该数据包，尽快交给应用程序，不要在缓冲区排队

RST:重置链接标志。由于主机崩溃等导致非法链接、非法报文段，非法请求

**SYN**:同步序号，标志建立链接。SYN=1，ACK=0没有使用捎带的确认域。 SYN=1，ACK=1使用捎带的确认域

**FIN**：释放链接标志。1：发送方没有待发送的数据流，可关闭链接

2个字节window窗口大小:告知发送端接收端缓存大小，控制发送端发送速率，流控

16奇偶

### 3.3三次握手

#### 3.3.1三次握手示意图



![img](https://images2015.cnblogs.com/blog/964016/201608/964016-20160829221352886-141830767.png)

#### 3.3.2为什么三次握手建立链接？

初始化 sequence序号值，需要通知对方sequence数值。这个值作为以后通信的序号。tcp为根据这个序号拼接数据，防止数据包乱序。

#### 3.3.3SYN超时问题

三次握手中，如果server端迟迟收不到client端的ack确认。在此期间，服务端会不断的向client端重新发包，重试5次，每次失败，重试时间翻倍。5次的重试时间间隔为1s, 2s, 4s, 8s, 16s,32s服务端在63s断掉链接。

如何防止syn flood？(client端恶意攻击)

client端发送SYN下线；server端会不断重试，向client端发送syn+ack；容易造成syn队列过长，攻击者就可以把服务器的syn连接的队列耗尽，让正常的连接请求不能处理。通过tcp_synccookies回发SYN cookie。当SYN队列满了后，TCP会通过源地址端口、目标地址端口和时间戳打造出一个特别的Sequence Number发回去（又叫cookie），如果是攻击者则不会有响应，如果是正常连接，则会把这个 SYN Cookie发回来，然后服务端可以通过cookie建连接（即使你不在SYN队列中）。

对于正常的请求，你应该调整三个TCP参数可供你选择，第一个是：tcp_synack_retries 可以用他来减少重试次数；第二个是：tcp_max_syn_backlog，可以增大SYN连接数；第三个是：tcp_abort_on_overflow 处理不过来干脆就直接拒绝连接了。

### 3.4TCP四次挥手

#### 3.4.TCP四次挥手示意图



![img](https://images2015.cnblogs.com/blog/964016/201608/964016-20160829222234683-593863018.png)

#####  3.4.1为什么要有TIME-WAIT状态,为什么要等待2MSL

TIME_WAIT状态为了保证服务器有足够时间收到ack；如果服务器没有接收到client端发送的ack，服务器会重新发送FIN,ACK包，一来一回正好是2MSL时间。

有足够时间与后续链接隔离

##### 3.4.2为什么要四次挥手断开链接

TCP是全双工，client，server都需要发送FIN,ACK报文，所以一共四次

##### 3.4.3tcp链接中存在大量CLOSE_WAIT

client关闭了链接，但是server端忙于读写(没有发送ACK、FIN)，并未及时关闭链接

### 3.3TCP滑动窗口

#### 3.3.1 RTT与RTO

RTT:发送一个数据包到接收ACK的时间

RTO:重传间隔。(发送一个数据包，启动一个重传定时器；如果没有回复ACK，定时器时间到了，所以会重传这个数据包)

#### 3.3.2滑动窗口

1.提供TCP可靠性，流控，乱序重排

2.滑动窗口：

​    发送方:已发送+已收到ACK的，已发送+未收到ACK，未发送+接收方可接收的,未发送+超过窗口大小的

中间两个成为滑动窗口



## 4.UDP

### 4.1UDP简介

无连接。当进行数据传输时，双端无需建立链接。UDP 仅受计算机速度、产生数据速度、带宽因素决定。

一台服务器可以向多个client发送多个消息

数据报文头8b

不可靠

数据报文无需拆分、合并报文

用于视频，在线游戏等

   